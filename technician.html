<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Rota</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="main-menu">
    <ul>
        <li><a href="/index.html" class="logo">SGRT</a></li>
        <li class="nav-links">
            <a href="/admin.html">Painel Admin</a>
            <a href="/index.html">Sair (Logout)</a>
        </li>
    </ul>
</nav>

<h1>Minha Rota do Dia</h1>

<div class="container">
    <div class="panel" id="my-route-panel" style="flex-basis: 100%;">
        <div id="my-route-container">
            <p>Carregando rota...</p>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://sgrt-api.onrender.com';
    const routeContainer = document.getElementById('my-route-container');

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert(`Copiado para a √°rea de transfer√™ncia:\n"${text}"`);
        }).catch(err => {
            console.error('Erro ao copiar texto: ', err);
            alert('Falha ao copiar o texto.');
        });
    }

    async function updateStatus(orderId, newStatus) {
        let justification = null;
        if (newStatus === 'REAGENDADA') {
            justification = prompt("Por favor, digite o motivo do reagendamento:");
            if (!justification) {
                alert("O reagendamento foi cancelado pois a justificativa √© obrigat√≥ria.");
                return;
            }
        }
        try {
            const response = await fetch(`${API_URL}/service-orders/${orderId}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus, justification: justification })
            });
            if (response.ok) {
                alert(`Status atualizado para ${newStatus}`);
                loadMyRoute();
            } else {
                alert('Falha ao atualizar o status.');
            }
        } catch (error) {
            console.error('Erro ao atualizar status:', error);
            alert('Erro de conex√£o ao atualizar status.');
        }
    }

    async function loadMyRoute() {
        const params = new URLSearchParams(window.location.search);
        const technicianId = params.get('id');
        if (!technicianId) {
            routeContainer.innerHTML = '<h2>Erro: ID do t√©cnico n√£o foi encontrado na URL.</h2>';
            return;
        }
        routeContainer.innerHTML = '<p>Buscando sua rota...</p>';
        try {
            const response = await fetch(`${API_URL}/my-route/${technicianId}`);
            if (!response.ok) throw new Error(`Erro da API: ${response.statusText}`);
            const orders = await response.json();
            if (orders.length === 0) {
                routeContainer.innerHTML = '<h2>Nenhuma Ordem de Servi√ßo atribu√≠da para hoje.</h2>';
                return;
            }
            routeContainer.innerHTML = '';
            
            const manhaOrders = orders.filter(order => order.period === 'MANHA');
            const tardeOrders = orders.filter(order => order.period === 'TARDE');

            const renderOrderGroup = (title, orderList) => {
                if (orderList.length > 0) {
                    const groupTitle = document.createElement('h2');
                    groupTitle.textContent = title;
                    routeContainer.appendChild(groupTitle);
                    orderList.forEach(order => {
                        const textToCopy = `${order.clientId} - ${order.clientName}`;
                        const osCard = document.createElement('div');
                        osCard.className = 'os-card';
                        osCard.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <p><strong>ID Cliente:</strong> ${order.clientId} - <strong>Cliente:</strong> ${order.clientName}</p>
                                <button onclick="copyToClipboard('${textToCopy}')" style="font-size:12px; padding: 5px 8px;">Copiar</button>
                            </div>
                            <p><strong>Endere√ßo:</strong> ${order.address}</p>
                            <p><strong>Problema:</strong> ${order.problemDescription}</p>
                            <p><strong>Prioridade (Base):</strong> ${order.priority}</p>
                            <p><strong>Observa√ß√µes:</strong> ${order.notes || 'Nenhuma'}</p>
                            <p><strong>Status:</strong> <span class="status-${order.status.toLowerCase()}">${order.status.replace('_', ' ')}</span></p>
                            <div class="actions">
                                <button onclick="updateStatus('${order.id}', 'A_CAMINHO')">A Caminho</button>
                                <button onclick="updateStatus('${order.id}', 'EXECUTANDO')">Executando</button>
                                <button onclick="updateStatus('${order.id}', 'FINALIZADA')">Finalizar</button>
                                <button onclick="updateStatus('${order.id}', 'REAGENDADA')">Reagendar</button>
                            </div>
                        `;
                        routeContainer.appendChild(osCard);
                    });
                }
            };

            renderOrderGroup('‚òÄÔ∏è MANH√É', manhaOrders);
            renderOrderGroup('üåô TARDE', tardeOrders);

        } catch (error) {
            console.error('Erro ao buscar rota:', error);
            routeContainer.innerHTML = '<h2>N√£o foi poss√≠vel carregar sua rota. A API pode estar indispon√≠vel. Tente recarregar a p√°gina em um minuto.</h2>';
        }
    }

    document.addEventListener('DOMContentLoaded', loadMyRoute);
</script>
</body>
</html>
