<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gest√£o SGRT</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body>

<nav class="main-menu">
    <ul>
        <li><a href="/admin.html" class="logo">SGRT Admin</a></li>
        <li class="nav-links">
            <a href="/monitoring.html">Monitoramento</a>
            <button id="theme-toggle" class="nav-button">Modo Escuro</button>
            <a href="/index.html">Sair</a>
        </li>
    </ul>
</nav>

<div class="main-container">
    <h1>Painel de Gest√£o</h1>
    <div class="panel-group">
        <div class="panel">
            <h2>Gerenciar T√©cnicos</h2>
            <form id="form-create-technician">
                <h3>Adicionar Novo T√©cnico</h3>
                <input type="text" id="tech-name" placeholder="Nome do T√©cnico" required>
                <input type="email" id="tech-email" placeholder="Email do T√©cnico" required>
                <input type="password" id="tech-password" placeholder="Senha Tempor√°ria" required>
                <button type="submit">Adicionar T√©cnico</button>
            </form>
            <hr>
            <h3>T√©cnicos Cadastrados</h3>
            <ul id="technician-list"><li>Carregando...</li></ul>
        </div>
        <div class="panel">
            <h2>Importar Ordens de Servi√ßo</h2>
            <form id="form-import-routes">
                <textarea id="bulk-routes" rows="10" placeholder="Cole as rotas aqui, uma por linha.&#10;ID Cliente - Nome - Bairro - Servi√ßo - Base (D1/D2)"></textarea>
                <p>Atribuir para:</p>
                <select id="import-technician-select" required></select>
                <select id="import-period-select" required>
                    <option value="MANHA">Manh√£</option>
                    <option value="TARDE">Tarde</option>
                </select>
                <button type="submit">Importar e Atribuir</button>
            </form>
        </div>
    </div>

    <div class="panel full-width-panel">
        <h2>Rotas do Dia (Arraste os cards para reordenar)</h2>
        <div id="routes-container"><p>As rotas agendadas aparecer√£o aqui.</p></div>
    </div>
</div>


<div id="edit-os-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeEditModal()">&times;</span>
        <h2>Editar Ordem de Servi√ßo</h2>
        <form id="form-edit-os">
            <input type="hidden" id="edit-os-id">
            <label for="edit-clientId">ID Cliente:</label>
            <input type="number" id="edit-clientId" required>
            <label for="edit-clientName">Nome do Cliente:</label>
            <input type="text" id="edit-clientName" required>
            <label for="edit-address">Endere√ßo (Bairro):</label>
            <input type="text" id="edit-address" required>
            <label for="edit-problem">Servi√ßo/Problema:</label>
            <input type="text" id="edit-problem" required>
            <label for="edit-priority">Prioridade (Base):</label>
            <select id="edit-priority">
                <option value="D1">D1</option>
                <option value="D2">D2</option>
            </select>
            <label for="edit-period">Per√≠odo:</label>
            <select id="edit-period">
                <option value="MANHA">Manh√£</option>
                <option value="TARDE">Tarde</option>
            </select>
            <label for="edit-notes">Observa√ß√µes:</label>
            <textarea id="edit-notes"></textarea>
            <button type="submit">Salvar Altera√ß√µes</button>
        </form>
    </div>
</div>


<script>
    const API_URL = 'https://sgrt-api.onrender.com';

    // --- ELEMENTOS DO DOM ---
    const techForm = document.getElementById('form-create-technician');
    const techList = document.getElementById('technician-list');
    const importTechSelect = document.getElementById('import-technician-select');
    const routesContainer = document.getElementById('routes-container');
    const importForm = document.getElementById('form-import-routes');
    const themeToggle = document.getElementById('theme-toggle');
    const editModal = document.getElementById('edit-os-modal');
    const editForm = document.getElementById('form-edit-os');

    // --- INICIALIZA√á√ÉO E AUTENTICA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', () => {
        const user = JSON.parse(localStorage.getItem('sgrt_user'));
        if (!user || user.role !== 'ADMIN') {
            alert('Acesso negado.');
            window.location.href = '/index.html';
            return;
        }

        if (localStorage.getItem('sgrt_theme') === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = 'Modo Claro';
        }
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            themeToggle.textContent = theme === 'dark' ? 'Modo Claro' : 'Modo Escuro';
            localStorage.setItem('sgrt_theme', theme);
        });

        loadTechnicians();
        loadAllOrders();
    });

    // L√ìGICA DE T√âCNICOS (Completa)
    async function loadTechnicians() {
        try {
            const response = await fetch(`${API_URL}/technicians`);
            const technicians = await response.json();
            techList.innerHTML = '';
            importTechSelect.innerHTML = '<option value="">Selecione um T√©cnico</option>';
            if (technicians.length === 0) techList.innerHTML = '<li>Nenhum t√©cnico.</li>';
            technicians.forEach(tech => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${tech.name} (${tech.email})</span><div><button onclick="editTechnician('${tech.id}', '${tech.name}', '${tech.email}')" class="btn-secondary">Editar</button><button onclick="deleteTechnician('${tech.id}')" class="btn-danger">Excluir</button></div>`;
                techList.appendChild(li);
                const opt = document.createElement('option');
                opt.value = tech.id;
                opt.textContent = tech.name;
                importTechSelect.appendChild(opt);
            });
        } catch (error) { techList.innerHTML = `<li>Erro ao carregar.</li>`; }
    }
    techForm.addEventListener('submit', async e => { e.preventDefault(); const d = { name: document.getElementById('tech-name').value, email: document.getElementById('tech-email').value, password: document.getElementById('tech-password').value }; try { const r = await fetch(`${API_URL}/technicians`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)}); if(r.ok){alert('Adicionado!'); techForm.reset(); loadTechnicians();}else{alert('Falha.');}} catch (err){alert('Erro.');}});
    async function deleteTechnician(id) { if (!confirm('Tem certeza?')) return; try { const r = await fetch(`${API_URL}/technicians/${id}`,{method:'DELETE'}); if (r.ok){alert('Exclu√≠do!'); loadTechnicians(); loadAllOrders();} else {alert('Falha.');}} catch (err){alert('Erro.');}}
    function editTechnician(id, name, email) { const nN=prompt("Novo nome:", name); if(nN===null)return; const nE=prompt("Novo email:", email); if(nE===null)return; if(nN&&nE)updateTechnician(id,nN,nE); }
    async function updateTechnician(id, name, email) { try { const r = await fetch(`${API_URL}/technicians/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name,email})}); if (r.ok){alert('Atualizado!'); loadTechnicians();}else{alert('Falha.');}} catch (err){alert('Erro.');}}

    // --- L√ìGICA DE ORDENS DE SERVI√áO (Completa) ---
    async function loadAllOrders() {
        routesContainer.innerHTML = '<p>Carregando rotas...</p>';
        try {
            const response = await fetch(`${API_URL}/service-orders`);
            const orders = await response.json();
            if (orders.length === 0) { routesContainer.innerHTML = '<p>Nenhuma rota agendada.</p>'; return; }
            const routesByTechnician = orders.reduce((acc, order) => { const t = order.technician; if(!t) return acc; if(!acc[t.id]) acc[t.id]={name:t.name, orders:[]}; acc[t.id].orders.push(order); return acc; }, {});
            routesContainer.innerHTML = '';
            for (const techId in routesByTechnician) {
                const techData = routesByTechnician[techId];
                const column = document.createElement('div');
                column.className = 'technician-column';
                let html = `<h3>${techData.name}</h3>`;
                const manha = techData.orders.filter(o=>o.period==='MANHA');
                const tarde = techData.orders.filter(o=>o.period==='TARDE');
                html += `<div class="period-group"><h4>‚òÄÔ∏è MANH√É</h4><div class="os-list">`;
                manha.forEach(order => { html += renderOsCard(order); });
                html += `</div></div>`;
                html += `<div class="period-group"><h4>üåô TARDE</h4><div class="os-list">`;
                tarde.forEach(order => { html += renderOsCard(order); });
                html += `</div></div>`;
                column.innerHTML = html;
                routesContainer.appendChild(column);
            }
            document.querySelectorAll('.os-list').forEach(list => { new Sortable(list, { group: 'shared-os', animation: 150, onEnd: saveNewOrder }); });
        } catch (error) { routesContainer.innerHTML = `<p>Erro ao carregar rotas.</p>`; }
    }

    function renderOsCard(order) {
        return `<div class="os-card" data-id="${order.id}">
                    <div class="os-card-header">
                        <p><strong>ID:</strong> ${order.clientId} - ${order.clientName}</p>
                        <div>
                            <button title="Editar OS" onclick="openEditModal('${order.id}')" class="card-btn-edit">‚úé</button>
                            <button title="Transferir OS" onclick="transferOrder('${order.id}')" class="card-btn-transfer">‚áÜ</button>
                            <button title="Excluir OS" onclick="deleteOrder('${order.id}')" class="card-btn-delete">√ó</button>
                        </div>
                    </div>
                    <p><strong>Problema:</strong> ${order.problemDescription}</p>
                    <p><strong>Endere√ßo:</strong> ${order.address}</p>
                    <p><strong>Status:</strong> <span class="status-${order.status.toLowerCase()}">${order.status.replace('_', ' ')}</span></p>
                </div>`;
    }
    
    async function deleteOrder(id) { if(!confirm('Excluir esta OS?'))return; try{const r=await fetch(`${API_URL}/service-orders/${id}`,{method:'DELETE'});if(r.ok)loadAllOrders();else alert('Falha.');}catch(e){alert('Erro.');}}
    async function saveNewOrder(evt) { const list = evt.from.closest('.os-list'); const orderedIds = Array.from(list.children).map(c=>c.dataset.id); try {await fetch(`${API_URL}/service-orders/reorder`, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({orderedIds})});}catch(e){alert('Erro ao salvar ordem.');}}
    async function transferOrder(id) { try {const r=await fetch(`${API_URL}/technicians`); const t=await r.json(); let opts=t.map((tech,i)=>`${i+1}-${tech.name}`).join('\n'); const c=prompt(`Transferir para:\n${opts}`); if(!c)return; const i=parseInt(c)-1; if(t[i]){ const nTID=t[i].id; await fetch(`${API_URL}/service-orders/${id}/transfer`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({newTechnicianId:nTID})}); loadAllOrders();}else{alert("Sele√ß√£o inv√°lida.");}}catch(e){alert('Erro.');}}

    importForm.addEventListener('submit', async e => { e.preventDefault(); const tId=importTechSelect.value; const p=document.getElementById('import-period-select').value; const txt=document.getElementById('bulk-routes').value; if(!tId)return alert('Selecione um t√©cnico.'); const lines=txt.split('\n').filter(l=>l.trim()!==''); if(lines.length===0)return alert('Cole as rotas.'); for(const[i,l] of lines.entries()){const rgx=/^(\d+)\s*-\s*(.+?)\s*-\s*(.+?)\s*-\s*(.+?)\s*-\s*(.+)/i; const m=l.match(rgx); if(m){ let pri=m[5].trim().toUpperCase(); if(pri.includes("BASE 1"))pri="D1";if(pri.includes("BASE 2"))pri="D2"; const d={clientId:parseInt(m[1]),clientName:m[2].trim(),address:m[3].trim(),problemDescription:m[4].trim(),priority:pri,period:p,technicianId:tId,position:i}; try{await fetch(`${API_URL}/service-orders`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)})}catch(err){alert(`Erro na OS: ${d.clientId}`);}}else{alert(`Linha ignorada: "${l}"`);}} alert('Importa√ß√£o finalizada!'); loadAllOrders(); importForm.reset();});

    // --- L√ìGICA DO MODAL DE EDI√á√ÉO ---
    async function openEditModal(orderId) {
        try {
            const response = await fetch(`${API_URL}/service-orders/${orderId}`);
            if (!response.ok) return alert('Erro ao buscar dados da OS.');
            const order = await response.json();
            
            document.getElementById('edit-os-id').value = order.id;
            document.getElementById('edit-clientId').value = order.clientId;
            document.getElementById('edit-clientName').value = order.clientName;
            document.getElementById('edit-address').value = order.address;
            document.getElementById('edit-problem').value = order.problemDescription;
            document.getElementById('edit-priority').value = order.priority;
            document.getElementById('edit-period').value = order.period;
            document.getElementById('edit-notes').value = order.notes || '';
            
            editModal.style.display = 'flex';
        } catch (error) { alert('Erro de conex√£o ao buscar dados da OS.'); }
    }

    function closeEditModal() {
        editModal.style.display = 'none';
    }

    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const orderId = document.getElementById('edit-os-id').value;
        const updatedData = {
            clientId: document.getElementById('edit-clientId').value,
            clientName: document.getElementById('edit-clientName').value,
            address: document.getElementById('edit-address').value,
            problemDescription: document.getElementById('edit-problem').value,
            priority: document.getElementById('edit-priority').value,
            period: document.getElementById('edit-period').value,
            notes: document.getElementById('edit-notes').value,
        };
        try {
            const response = await fetch(`${API_URL}/service-orders/${orderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });
            if (response.ok) {
                alert('OS atualizada com sucesso!');
                closeEditModal();
                loadAllOrders();
            } else {
                alert('Falha ao atualizar a OS.');
            }
        } catch (error) { alert('Erro de conex√£o ao salvar as altera√ß√µes.'); }
    });

    window.onclick = (event) => {
        if (event.target == editModal) {
            closeEditModal();
        }
    }
</script>

</body>
</html>
