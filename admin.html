<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gest√£o SGRT</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body>

<nav class="main-menu">
    <ul>
        <li><a href="/admin.html" class="logo">SGRT Admin</a></li>
        <li class="nav-links">
            <button id="theme-toggle" class="nav-button">Modo Escuro</button>
            <a href="/index.html">Sair</a>
        </li>
    </ul>
</nav>

<div class="main-container">
    <h1>Painel de Gest√£o</h1>
    <div class="panel-group">
        <div class="panel">
            <h2>Gerenciar T√©cnicos</h2>
            <form id="form-create-technician">
                <h3>Adicionar Novo T√©cnico</h3>
                <input type="text" id="tech-name" placeholder="Nome do T√©cnico" required>
                <input type="email" id="tech-email" placeholder="Email do T√©cnico" required>
                <input type="password" id="tech-password" placeholder="Senha Tempor√°ria" required>
                <button type="submit">Adicionar T√©cnico</button>
            </form>
            <hr>
            <h3>T√©cnicos Cadastrados</h3>
            <ul id="technician-list"><li>Carregando...</li></ul>
        </div>
        <div class="panel">
            <h2>Importar Ordens de Servi√ßo</h2>
            <form id="form-import-routes">
                <textarea id="bulk-routes" rows="10" placeholder="Cole as rotas aqui, uma por linha.&#10;ID Cliente - Nome - Bairro - Servi√ßo - Base (D1/D2)"></textarea>
                <p>Atribuir para:</p>
                <select id="import-technician-select" required></select>
                <select id="import-period-select" required>
                    <option value="MANHA">Manh√£</option>
                    <option value="TARDE">Tarde</option>
                </select>
                <button type="submit">Importar e Atribuir</button>
            </form>
        </div>
    </div>

    <div class="panel full-width-panel">
        <h2>Rotas do Dia (Arraste os cards para reordenar)</h2>
        <div id="routes-container"><p>As rotas agendadas aparecer√£o aqui.</p></div>
    </div>
</div>

<script>
    const API_URL = 'https://sgrt-api.onrender.com';

    // --- ELEMENTOS DO DOM ---
    const techForm = document.getElementById('form-create-technician');
    const techList = document.getElementById('technician-list');
    const importTechSelect = document.getElementById('import-technician-select');
    const routesContainer = document.getElementById('routes-container');
    const importForm = document.getElementById('form-import-routes');
    const themeToggle = document.getElementById('theme-toggle');

    // --- INICIALIZA√á√ÉO E AUTENTICA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', () => {
        // Verifica se o usu√°rio √© Admin
        const user = JSON.parse(localStorage.getItem('sgrt_user'));
        if (!user || user.role !== 'ADMIN') {
            alert('Acesso negado.');
            window.location.href = '/index.html';
            return;
        }

        // Configura o tema (claro/escuro)
        if (localStorage.getItem('sgrt_theme') === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = 'Modo Claro';
        }
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            themeToggle.textContent = theme === 'dark' ? 'Modo Claro' : 'Modo Escuro';
            localStorage.setItem('sgrt_theme', theme);
        });

        // Carrega os dados iniciais
        loadTechnicians();
        loadAllOrders();
    });

    // --- L√ìGICA DE T√âCNICOS ---
    async function loadTechnicians() {
        try {
            const response = await fetch(`${API_URL}/technicians`);
            if (!response.ok) throw new Error('Falha ao carregar t√©cnicos');
            const technicians = await response.json();
            
            techList.innerHTML = '';
            importTechSelect.innerHTML = '<option value="">Selecione um T√©cnico</option>';
            if (technicians.length === 0) techList.innerHTML = '<li>Nenhum t√©cnico cadastrado.</li>';

            technicians.forEach(tech => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<span>${tech.name} (${tech.email})</span><div><button onclick="editTechnician('${tech.id}', '${tech.name}', '${tech.email}')" class="btn-secondary">Editar</button><button onclick="deleteTechnician('${tech.id}')" class="btn-danger">Excluir</button></div>`;
                techList.appendChild(listItem);

                const optionItem = document.createElement('option');
                optionItem.value = tech.id;
                optionItem.textContent = tech.name;
                importTechSelect.appendChild(optionItem.cloneNode(true));
            });
        } catch (error) { techList.innerHTML = `<li>${error.message}</li>`; }
    }

    techForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = { name: document.getElementById('tech-name').value, email: document.getElementById('tech-email').value, password: document.getElementById('tech-password').value };
        try {
            const r = await fetch(`${API_URL}/technicians`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (r.ok) { alert('T√©cnico adicionado!'); techForm.reset(); loadTechnicians(); } else { alert('Falha. Email j√° existe?'); }
        } catch (err) { alert('Erro de conex√£o.'); }
    });

    async function deleteTechnician(id) {
        if (!confirm('Tem certeza? Isso excluir√° o t√©cnico e todas as suas OS.')) return;
        try {
            const r = await fetch(`${API_URL}/technicians/${id}`, { method: 'DELETE' });
            if (r.ok) { alert('Exclu√≠do!'); loadTechnicians(); loadAllOrders(); } else { alert('Falha.'); }
        } catch (err) { alert('Erro.'); }
    }

    function editTechnician(id, name, email) {
        const newName = prompt("Novo nome:", name); if (newName === null) return;
        const newEmail = prompt("Novo email:", email); if (newEmail === null) return;
        if (newName && newEmail) updateTechnician(id, newName, newEmail);
    }

    async function updateTechnician(id, name, email) {
        try {
            const r = await fetch(`${API_URL}/technicians/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, email }) });
            if (r.ok) { alert('Atualizado!'); loadTechnicians(); loadAllOrders(); } else { alert('Falha.'); }
        } catch (err) { alert('Erro.'); }
    }

    // --- L√ìGICA DE ORDENS DE SERVI√áO ---
    async function loadAllOrders() {
        routesContainer.innerHTML = '<p>Carregando rotas...</p>';
        try {
            const response = await fetch(`${API_URL}/service-orders`);
            const orders = await response.json();
            if (orders.length === 0) { routesContainer.innerHTML = '<p>Nenhuma rota agendada.</p>'; return; }
            
            const routesByTechnician = orders.reduce((acc, order) => {
                const tech = order.technician;
                if (!tech) return acc;
                if (!acc[tech.id]) acc[tech.id] = { name: tech.name, orders: [] };
                acc[tech.id].orders.push(order);
                return acc;
            }, {});

            routesContainer.innerHTML = '';
            for (const techId in routesByTechnician) {
                const techData = routesByTechnician[techId];
                const columnDiv = document.createElement('div');
                columnDiv.className = 'technician-column';
                let columnHtml = `<h3>${techData.name}</h3>`;
                
                const manhaOrders = techData.orders.filter(o => o.period === 'MANHA');
                const tardeOrders = techData.orders.filter(o => o.period === 'TARDE');

                columnHtml += `<div class="period-group" data-period="MANHA"><h4>‚òÄÔ∏è MANH√É</h4><div class="os-list">`;
                manhaOrders.forEach(order => { columnHtml += renderOsCard(order); });
                columnHtml += `</div></div>`;

                columnHtml += `<div class="period-group" data-period="TARDE"><h4>üåô TARDE</h4><div class="os-list">`;
                tardeOrders.forEach(order => { columnHtml += renderOsCard(order); });
                columnHtml += `</div></div>`;
                
                columnDiv.innerHTML = columnHtml;
                routesContainer.appendChild(columnDiv);
            }

            document.querySelectorAll('.os-list').forEach(list => {
                new Sortable(list, { group: 'shared-os', animation: 150, onEnd: saveNewOrder });
            });
        } catch (error) { routesContainer.innerHTML = `<p>Erro ao carregar rotas: ${error.message}</p>`; }
    }

    function renderOsCard(order) {
        return `
            <div class="os-card" data-id="${order.id}">
                <div class="os-card-header">
                    <p><strong>ID:</strong> ${order.clientId} - ${order.clientName}</p>
                    <div>
                        <button title="Transferir OS" onclick="transferOrder('${order.id}')" class="card-btn-transfer">‚áÜ</button>
                        <button title="Excluir OS" onclick="deleteOrder('${order.id}')" class="card-btn-delete">√ó</button>
                    </div>
                </div>
                <p><strong>Problema:</strong> ${order.problemDescription}</p>
                <p><strong>Endere√ßo:</strong> ${order.address}</p>
                <p><strong>Status:</strong> <span class="status-${order.status.toLowerCase()}">${order.status.replace('_', ' ')}</span></p>
            </div>
        `;
    }

    async function deleteOrder(orderId) {
        if (!confirm('Tem certeza que deseja excluir esta OS?')) return;
        try {
            const response = await fetch(`${API_URL}/service-orders/${orderId}`, { method: 'DELETE' });
            if (response.ok) { loadAllOrders(); } else { alert('Falha ao excluir a OS.'); }
        } catch (error) { alert('Erro de conex√£o ao excluir a OS.'); }
    }

    async function saveNewOrder(event) {
        const allOsCards = Array.from(document.querySelectorAll('.os-card'));
        const orderedIds = allOsCards.map(card => card.dataset.id);
        try {
            await fetch(`${API_URL}/service-orders/reorder`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ orderedIds: orderedIds })
            });
        } catch (error) { console.error("Falha ao salvar ordem:", error); alert("Erro ao salvar nova ordem."); }
    }

    async function transferOrder(orderId) {
        try {
            const techResponse = await fetch(`${API_URL}/technicians`);
            const technicians = await techResponse.json();
            let options = technicians.map((t, i) => `${i + 1} - ${t.name}`).join('\n');
            const choice = prompt(`Para qual t√©cnico deseja transferir?\n${options}`);
            if (!choice) return;
            const choiceIndex = parseInt(choice) - 1;
            if (technicians[choiceIndex]) {
                const newTechnicianId = technicians[choiceIndex].id;
                await fetch(`${API_URL}/service-orders/${orderId}/transfer`, {
                    method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ newTechnicianId })
                });
                loadAllOrders();
            } else { alert("Sele√ß√£o inv√°lida."); }
        } catch (error) { alert('Erro ao buscar t√©cnicos.'); }
    }

    importForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const technicianId = importTechSelect.value;
        const period = document.getElementById('import-period-select').value;
        const text = document.getElementById('bulk-routes').value;
        if (!technicianId) return alert('Selecione um t√©cnico.');
        const lines = text.split('\n').filter(line => line.trim() !== '');
        if (lines.length === 0) return alert('Cole as rotas.');
        
        for (const [index, line] of lines.entries()) {
            const regex = /^(\d+)\s*-\s*(.+?)\s*-\s*(.+?)\s*-\s*(.+?)\s*-\s*(.+)/i;
            const match = line.match(regex);
            if (match) {
                let priority = match[5].trim().toUpperCase();
                if (priority.includes("BASE 1")) priority = "D1"; if (priority.includes("BASE 2")) priority = "D2";
                const osData = { clientId: parseInt(match[1]), clientName: match[2].trim(), address: match[3].trim(), problemDescription: match[4].trim(), priority, period, technicianId, position: index };
                try {
                    await fetch(`${API_URL}/service-orders`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(osData) });
                } catch (err) { alert(`Erro de conex√£o na OS: ${osData.clientId}`); }
            } else { alert(`Linha ignorada: "${line}"`); }
        }
        alert('Importa√ß√£o finalizada!');
        loadAllOrders();
        importForm.reset();
    });
</script>

</body>
</html>
