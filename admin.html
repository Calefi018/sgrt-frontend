<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gest√£o SGRT</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<nav class="main-menu">
    <ul>
        <li><a href="/index.html" class="logo">SGRT</a></li>
        <li class="nav-links">
            <a href="/admin.html">Painel Admin</a>
            <a href="/index.html">Sair (Logout)</a>
        </li>
    </ul>
</nav>

<h1>Painel de Gest√£o SGRT</h1>

<div class="container">
    <div class="panel">
        <h2>Gerenciar T√©cnicos</h2>
        <form id="form-create-technician">
            <h3>Adicionar Novo T√©cnico</h3>
            <input type="text" id="tech-name" placeholder="Nome do T√©cnico" required>
            <input type="email" id="tech-email" placeholder="Email do T√©cnico" required>
            <input type="password" id="tech-password" placeholder="Senha Tempor√°ria" required>
            <button type="submit">Adicionar T√©cnico</button>
        </form>
        <hr>
        <h3>T√©cnicos Cadastrados</h3>
        <ul id="technician-list">
            <li>Carregando...</li>
        </ul>
    </div>

    <div class="panel">
        <h2>Gerenciar Ordens de Servi√ßo</h2>
        
        <h3>Importar Rotas em Massa</h3>
        <form id="form-import-routes">
            <textarea id="bulk-routes" rows="10" placeholder="Cole as rotas aqui, uma por linha.&#10;Formato: ID Cliente - Nome - Bairro - Servi√ßo - Base (D1/D2)"></textarea>
            <p>Atribuir todas as rotas importadas para:</p>
            <select id="import-technician-select" required></select>
            <select id="import-period-select" required>
                <option value="MANHA">Manh√£</option>
                <option value="TARDE">Tarde</option>
            </select>
            <button type="submit">Importar e Atribuir Rotas</button>
        </form>
    </div>
</div>

<div class="container">
    <div class="panel" style="flex-basis: 100%;">
        <h2>Rotas do Dia</h2>
        <div id="routes-container">
            <p>As rotas agendadas aparecer√£o aqui.</p>
        </div>
    </div>
</div>


<script>
    const API_URL = 'https://sgrt-api.onrender.com';

    // --- ELEMENTOS DO DOM ---
    const techForm = document.getElementById('form-create-technician');
    const techList = document.getElementById('technician-list');
    const importTechSelect = document.getElementById('import-technician-select');
    const routesContainer = document.getElementById('routes-container');
    const importForm = document.getElementById('form-import-routes');

    // --- L√ìGICA DE T√âCNICOS ---
    async function loadTechnicians() {
        try {
            const response = await fetch(`${API_URL}/technicians`);
            if (!response.ok) throw new Error('Falha na resposta da API');
            const technicians = await response.json();
            
            techList.innerHTML = '';
            importTechSelect.innerHTML = '<option value="">Selecione um T√©cnico</option>';

            if (technicians.length === 0) {
                techList.innerHTML = '<li>Nenhum t√©cnico cadastrado.</li>';
            }

            technicians.forEach(tech => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span>${tech.name} (${tech.email})</span>
                    <div>
                        <button onclick="editTechnician('${tech.id}', '${tech.name}', '${tech.email}')" style="font-size:12px; padding: 5px 8px;">Editar</button>
                        <button onclick="deleteTechnician('${tech.id}')" style="background-color: #e74c3c; font-size:12px; padding: 5px 8px;">Excluir</button>
                    </div>
                `;
                techList.appendChild(listItem);

                const optionItem = document.createElement('option');
                optionItem.value = tech.id;
                optionItem.textContent = tech.name;
                importTechSelect.appendChild(optionItem.cloneNode(true));
            });
        } catch (error) {
            console.error("Erro ao carregar t√©cnicos:", error);
            techList.innerHTML = '<li>Erro ao carregar t√©cnicos. A API pode estar offline.</li>';
        }
    }

    techForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const techData = { name: document.getElementById('tech-name').value, email: document.getElementById('tech-email').value, password: document.getElementById('tech-password').value };
        try {
            const response = await fetch(`${API_URL}/technicians`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(techData) });
            if (response.ok) {
                alert('T√©cnico adicionado com sucesso!');
                techForm.reset();
                loadTechnicians();
            } else {
                alert('Falha ao adicionar t√©cnico. O email j√° pode existir.');
            }
        } catch (error) { console.error("Erro ao criar t√©cnico:", error); alert('Erro de conex√£o ao criar t√©cnico.'); }
    });

    async function deleteTechnician(id) {
        if (!confirm('Tem certeza que deseja excluir este t√©cnico? Todas as OS dele tamb√©m ser√£o removidas.')) return;
        try {
            const response = await fetch(`${API_URL}/technicians/${id}`, { method: 'DELETE' });
            if (response.ok) {
                alert('T√©cnico exclu√≠do com sucesso.');
                loadTechnicians();
                loadAllOrders();
            } else {
                alert('Falha ao excluir o t√©cnico.');
            }
        } catch (error) { alert('Erro de conex√£o ao excluir t√©cnico.'); }
    }

    function editTechnician(id, currentName, currentEmail) {
        const newName = prompt("Digite o novo nome:", currentName);
        if (newName === null) return;
        const newEmail = prompt("Digite o novo email:", currentEmail);
        if (newEmail === null) return;
        if (newName && newEmail) updateTechnician(id, newName, newEmail);
    }

    async function updateTechnician(id, name, email) {
        try {
            const response = await fetch(`${API_URL}/technicians/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, email }) });
            if (response.ok) {
                alert('T√©cnico atualizado com sucesso!');
                loadTechnicians();
            } else {
                alert('Falha ao atualizar o t√©cnico.');
            }
        } catch (error) { alert('Erro de conex√£o ao atualizar t√©cnico.'); }
    }

    // --- L√ìGICA DE ORDENS DE SERVI√áO ---
    async function loadAllOrders() {
        routesContainer.innerHTML = '<p>Carregando rotas do dia...</p>';
        try {
            const response = await fetch(`${API_URL}/service-orders`);
            const orders = await response.json();
            if (orders.length === 0) {
                routesContainer.innerHTML = '<p>Nenhuma rota agendada para hoje.</p>';
                return;
            }
            const routesByTechnician = orders.reduce((acc, order) => {
                const techName = order.technician ? order.technician.name : 'Sem T√©cnico';
                if (!acc[techName]) acc[techName] = [];
                acc[techName].push(order);
                return acc;
            }, {});
            routesContainer.innerHTML = '';
            for (const techName in routesByTechnician) {
                const columnDiv = document.createElement('div');
                columnDiv.className = 'technician-column';
                let columnHtml = `<h3>${techName}</h3>`;
                const manhaOrders = routesByTechnician[techName].filter(o => o.period === 'MANHA');
                const tardeOrders = routesByTechnician[techName].filter(o => o.period === 'TARDE');
                if (manhaOrders.length > 0) {
                    columnHtml += `<h4>‚òÄÔ∏è MANH√É</h4>`;
                    manhaOrders.forEach(order => {
                        columnHtml += `<div class="os-card"><p><strong>ID Cliente:</strong> ${order.clientId} - ${order.clientName}</p><p><strong>Problema:</strong> ${order.problemDescription}</p><p><strong>Status:</strong> <span class="status-${order.status.toLowerCase()}">${order.status.replace('_', ' ')}</span></p></div>`;
                    });
                }
                if (tardeOrders.length > 0) {
                    columnHtml += `<h4>üåô TARDE</h4>`;
                    tardeOrders.forEach(order => {
                        columnHtml += `<div class="os-card"><p><strong>ID Cliente:</strong> ${order.clientId} - ${order.clientName}</p><p><strong>Problema:</strong> ${order.problemDescription}</p><p><strong>Status:</strong> <span class="status-${order.status.toLowerCase()}">${order.status.replace('_', ' ')}</span></p></div>`;
                    });
                }
                columnDiv.innerHTML = columnHtml;
                routesContainer.appendChild(columnDiv);
            }
        } catch (error) { console.error("Erro ao carregar Ordens de Servi√ßo:", error); routesContainer.innerHTML = '<p>Erro ao carregar rotas. A API pode estar offline.</p>'; }
    }

    importForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const technicianId = document.getElementById('import-technician-select').value;
        const period = document.getElementById('import-period-select').value;
        const text = document.getElementById('bulk-routes').value;
        if (!technicianId) return alert('Por favor, selecione um t√©cnico para atribuir as rotas.');
        const lines = text.split('\n').filter(line => line.trim() !== '');
        if (lines.length === 0) return alert('Por favor, cole as rotas na caixa de texto.');
        alert(`Iniciando importa√ß√£o de ${lines.length} rotas.`);
        for (const line of lines) {
            const regex = /^(\d+)\s*-\s*(.+?)\s*-\s*(.+?)\s*-\s*(.+?)\s*-\s*(.+)/i;
            const match = line.match(regex);
            if (match) {
                let priority = match[5].trim().toUpperCase();
                if (priority.includes("BASE 1")) priority = "D1";
                if (priority.includes("BASE 2")) priority = "D2";
                const osData = { clientId: parseInt(match[1]), clientName: match[2].trim(), address: match[3].trim(), problemDescription: match[4].trim(), priority: priority, period: period, notes: "Importado em massa.", technicianId: technicianId };
                try {
                    const response = await fetch(`${API_URL}/service-orders`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(osData) });
                    if (!response.ok) alert(`Falha ao importar OS do cliente ID ${osData.clientId}`);
                } catch (error) { alert(`Erro de conex√£o ao importar OS do cliente ID ${osData.clientId}`); }
            } else { alert(`A linha "${line}" n√£o est√° no formato correto e foi ignorada.`); }
        }
        alert('Importa√ß√£o finalizada!');
        loadAllOrders();
        importForm.reset();
    });

    // --- CARREGAMENTO INICIAL DA P√ÅGINA ---
    document.addEventListener('DOMContentLoaded', () => {
        loadTechnicians();
        loadAllOrders();
    });
</script>

</body>
</html>
