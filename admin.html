<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Rotas - SGRT</title>
    <link rel="stylesheet" href="style.css?v=1.1"> <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body>

<div class="app-container">
    <aside id="app-sidebar">
        <div>
            <div class="logo">SGRT</div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="/admin.html" class="active">üìù <span>Gest√£o de Rotas</span></a></li>
                    <li><a href="/monitoring.html">üì∫ <span>Monitoramento</span></a></li>
                    <li><a href="/reports.html">üìä <span>Relat√≥rios</span></a></li>
                </ul>
            </nav>
        </div>
        <div class="sidebar-footer">
            <a href="/index.html">Sair</a>
        </div>
    </aside>

    <main class="app-content">
        <header class="content-header">
            <h1>Gest√£o de Rotas</h1>
            <div class="header-actions">
                <button id="theme-toggle" class="nav-button">Modo Escuro</button>
            </div>
        </header>

        <div class="panel-group">
            <div class="panel">
                <h2>Gerenciar T√©cnicos</h2>
                <form id="form-create-technician">
                    <input type="text" id="tech-name" placeholder="Nome do T√©cnico" required>
                    <input type="email" id="tech-email" placeholder="Email do T√©cnico" required>
                    <input type="password" id="tech-password" placeholder="Senha Tempor√°ria" required>
                    <button type="submit">Adicionar T√©cnico</button>
                </form>
                <hr>
                <h3>T√©cnicos Cadastrados</h3>
                <ul id="technician-list"><li>Carregando...</li></ul>
            </div>
            <div class="panel">
                <h2>Importar Ordens de Servi√ßo</h2>
                <form id="form-import-routes">
                    <textarea id="bulk-routes" rows="10" placeholder="Cole aqui o bloco de texto do seu documento..."></textarea>
                    <button type="submit">Importar Rotas do Texto</button>
                </form>
            </div>
        </div>

        <div class="panel">
            <div class="content-header" style="margin-bottom: 20px;">
                <h2>Rotas do Dia (Arraste para reordenar)</h2>
                <button id="delete-all-os-btn" class="btn-delete-all">Excluir Todas as OS</button>
            </div>
            <div id="routes-container"><p>As rotas agendadas aparecer√£o aqui.</p></div>
        </div>
    </main>
</div>

<div id="edit-os-modal" class="modal">
    </div>


<script>
    const API_URL = 'https://sgrt-api.onrender.com';

    // --- ELEMENTOS DO DOM ---
    const techForm = document.getElementById('form-create-technician');
    const techList = document.getElementById('technician-list');
    const routesContainer = document.getElementById('routes-container');
    const importForm = document.getElementById('form-import-routes');
    const themeToggle = document.getElementById('theme-toggle');
    const editModal = document.getElementById('edit-os-modal');
    const editForm = document.getElementById('form-edit-os');
    const deleteAllBtn = document.getElementById('delete-all-os-btn');

    // --- INICIALIZA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', () => {
        // ... (l√≥gica de autentica√ß√£o e tema) ...
        deleteAllBtn.addEventListener('click', deleteAllOrders);
        loadTechnicians();
        loadAllOrders();
        setInterval(loadAllOrders, 30000);
    });
    // --- L√ìGICA DE T√âCNICOS ---
    async function loadTechnicians() {
        try {
            const response = await fetch(`${API_URL}/technicians`);
            const technicians = await response.json();
            techList.innerHTML = '';
            if (technicians.length === 0) {
                techList.innerHTML = '<li>Nenhum t√©cnico cadastrado.</li>';
                return;
            }
            technicians.forEach(tech => {
                const li = document.createElement('li');
                li.innerHTML = `<span>${tech.name} (${tech.email})</span><div><button onclick="editTechnician('${tech.id}', '${tech.name}', '${tech.email}')" class="btn-secondary">Editar</button><button onclick="deleteTechnician('${tech.id}')" class="btn-danger">Excluir</button></div>`;
                techList.appendChild(li);
            });
        } catch (error) {
            techList.innerHTML = `<li>Erro ao carregar t√©cnicos.</li>`;
        }
    }
    
    techForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            name: document.getElementById('tech-name').value,
            email: document.getElementById('tech-email').value,
            password: document.getElementById('tech-password').value
        };
        try {
            const response = await fetch(`${API_URL}/technicians`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (response.ok) {
                alert('T√©cnico adicionado com sucesso!');
                techForm.reset();
                loadTechnicians();
            } else {
                alert('Falha ao adicionar t√©cnico. O email j√° pode existir.');
            }
        } catch (err) {
            alert('Erro de conex√£o ao criar t√©cnico.');
        }
    });

    async function deleteTechnician(id) {
        if (!confirm('Tem certeza que quer excluir este t√©cnico? Todas as OS dele tamb√©m ser√£o removidas.')) return;
        try {
            const response = await fetch(`${API_URL}/technicians/${id}`, { method: 'DELETE' });
            if (response.ok) {
                alert('T√©cnico exclu√≠do com sucesso!');
                loadTechnicians();
                loadAllOrders();
            } else {
                alert('Falha ao excluir o t√©cnico.');
            }
        } catch (err) {
            alert('Erro de conex√£o ao excluir t√©cnico.');
        }
    }

    function editTechnician(id, name, email) {
        const newName = prompt("Digite o novo nome:", name);
        if (newName === null) return;
        const newEmail = prompt("Digite o novo email:", email);
        if (newEmail === null) return;
        if (newName && newEmail) {
            updateTechnician(id, newName, newEmail);
        }
    }

    async function updateTechnician(id, name, email) {
        try {
            const response = await fetch(`${API_URL}/technicians/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, email })
            });
            if (response.ok) {
                alert('T√©cnico atualizado com sucesso!');
                loadTechnicians();
                loadAllOrders();
            } else {
                alert('Falha ao atualizar o t√©cnico.');
            }
        } catch (err) {
            alert('Erro de conex√£o ao atualizar o t√©cnico.');
        }
    }

    // --- L√ìGICA DE ORDENS DE SERVI√áO ---
    async function loadAllOrders() {
        try {
            const response = await fetch(`${API_URL}/service-orders`);
            const orders = await response.json();
            const routesByTechnician = orders.reduce((acc, order) => {
                const tech = order.technician;
                if (!tech) return acc;
                if (!acc[tech.id]) {
                    acc[tech.id] = { name: tech.name, orders: [] };
                }
                acc[tech.id].orders.push(order);
                return acc;
            }, {});
            
            routesContainer.innerHTML = '';
            if (Object.keys(routesByTechnician).length === 0) {
                routesContainer.innerHTML = '<p>Nenhuma rota para exibir.</p>';
            }

            for (const techId in routesByTechnician) {
                const techData = routesByTechnician[techId];
                const column = document.createElement('div');
                column.className = 'technician-column';
                let html = `<h3>${techData.name}</h3>`;
                const manha = techData.orders.filter(o => o.period === 'MANHA').sort((a,b) => a.position - b.position);
                const tarde = techData.orders.filter(o => o.period === 'TARDE').sort((a,b) => a.position - b.position);
                
                html += `<div class="period-group"><h4>‚òÄÔ∏è MANH√É</h4><div class="os-list" id="list-manha-${techId}">`;
                if (manha.length > 0) manha.forEach(order => { html += renderOsCard(order); });
                html += `</div></div>`;

                html += `<div class="period-group"><h4>üåô TARDE</h4><div class="os-list" id="list-tarde-${techId}">`;
                if (tarde.length > 0) tarde.forEach(order => { html += renderOsCard(order); });
                html += `</div></div>`;

                column.innerHTML = html;
                routesContainer.appendChild(column);
            }

            document.querySelectorAll('.os-list').forEach(list => {
                new Sortable(list, {
                    group: 'shared-os',
                    animation: 150,
                    onEnd: saveNewOrder
                });
            });
        } catch (error) {
            routesContainer.innerHTML = `<p>Erro ao carregar rotas.</p>`;
        }
    }

    function renderOsCard(order) {
        const durationText = order.executionDuration ? `${order.executionDuration} min` : 'N/A';
        return `
            <div class="os-card" data-id="${order.id}">
                <div class="os-card-header">
                    <p><strong>ID:</strong> ${order.clientId} - ${order.clientName}</p>
                    <div>
                        <button title="Editar OS" onclick="openEditModal('${order.id}')" class="card-btn-edit">‚úé</button>
                        <button title="Transferir OS" onclick="transferOrder('${order.id}')" class="card-btn-transfer">‚áÜ</button>
                        <button title="Excluir OS" onclick="deleteOrder('${order.id}')" class="card-btn-delete">√ó</button>
                    </div>
                </div>
                <p><strong>Endere√ßo:</strong> ${order.address}</p>
                <p><strong>Problema:</strong> ${order.problemDescription}</p>
                <p><strong>Prioridade:</strong> ${order.priority}</p>
                <div class="os-card-footer">
                    <span class="status-badge status-${order.status.toLowerCase()}">${order.status.replace('_', ' ')}</span>
                    <p><strong>Execu√ß√£o:</strong> ${durationText}</p>
                </div>
            </div>`;
    }
    
    async function deleteOrder(id) {
        if (!confirm('Excluir esta OS?')) return;
        try {
            const response = await fetch(`${API_URL}/service-orders/${id}`, { method: 'DELETE' });
            if (response.ok) {
                loadAllOrders();
            } else {
                alert('Falha ao excluir OS.');
            }
        } catch (e) {
            alert('Erro de conex√£o.');
        }
    }

    async function saveNewOrder(evt) {
        const allCards = Array.from(document.querySelectorAll('.os-card'));
        const orderedIds = allCards.map(card => card.dataset.id);
        try {
            await fetch(`${API_URL}/service-orders/reorder`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ orderedIds })
            });
        } catch (e) {
            alert('Erro ao salvar nova ordem.');
        }
    }

    async function transferOrder(id) {
        try {
            const techResponse = await fetch(`${API_URL}/technicians`);
            const technicians = await techResponse.json();
            let options = technicians.map((tech, i) => `${i + 1} - ${tech.name}`).join('\n');
            const choice = prompt(`Transferir para:\n${options}`);
            if (!choice) return;
            const index = parseInt(choice) - 1;
            if (technicians[index]) {
                const newTechnicianId = technicians[index].id;
                if (confirm(`Tem certeza que quer transferir para ${technicians[index].name}?`)) {
                    await fetch(`${API_URL}/service-orders/${id}/transfer`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newTechnicianId })
                    });
                    loadAllOrders();
                }
            } else {
                alert("Sele√ß√£o inv√°lida.");
            }
        } catch (e) {
            alert('Erro ao buscar t√©cnicos.');
        }
    }

    // --- L√ìGICA DO IMPORTADOR INTELIGENTE ---
    function parseOsLine(line) {
        const idMatch = line.match(/^(\d+)\s*-/);
        if (!idMatch) {
            return { success: false, reason: "N√£o inicia com 'ID - '" };
        }
        const clientId = idMatch[1];
        let remainingLine = line.substring(idMatch[0].length).trim();
        
        let priority = 'D1';
        const priorityMatch = remainingLine.match(/(D\d|BASE\s*\d)\s*$/i);
        if (priorityMatch) {
            const pStr = priorityMatch[0].toUpperCase();
            priority = pStr.includes("D1") || pStr.includes("BASE 1") ? "D1" : "D2";
            remainingLine = remainingLine.substring(0, remainingLine.lastIndexOf(priorityMatch[0])).trim();
        }
        
        let notes = "Importado em massa.";
        const phoneRegex = /(\(\d{2}\)\s*9?\d{4,5}-?\d{4})/g;
        const phoneMatches = remainingLine.match(phoneRegex);
        if (phoneMatches) {
            notes += ` Tel: ${phoneMatches.join(', ')}`;
            remainingLine = remainingLine.replace(phoneRegex, '').trim();
        }
        
        remainingLine = remainingLine.replace(/--/g, '-').replace(/\s*-\s*$/, '').trim();
        const parts = remainingLine.split(/\s*-\s*/).map(p => p.trim()).filter(p => p);
        
        if (parts.length < 3) {
            return { success: false, reason: "Informa√ß√µes faltando (Nome, Bairro ou Servi√ßo)" };
        }

        return {
            success: true,
            data: {
                clientId: parseInt(clientId),
                priority,
                notes,
                clientName: parts[0],
                problemDescription: parts[parts.length - 1],
                address: parts.slice(1, -1).join(' - ')
            }
        };
    }
    
    importForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = document.getElementById('bulk-routes').value;
        const lines = text.split('\n');
        if (lines.length === 0) {
            return alert('Por favor, cole as rotas.');
        }
        
        const technicians = await (await fetch(`${API_URL}/technicians`)).json();
        const technicianMap = new Map(technicians.map(t => [t.name.toUpperCase(), t.id]));
        
        let currentTechnicianId = null;
        let currentPeriod = "MANHA";
        let unfoundTechs = new Set();
        let failedLines = [];
        let successCount = 0;
        let positionCounter = 0;

        for (const line of lines) {
            const trimmedLine = line.trim();
            if (!trimmedLine) continue;

            const upperLine = trimmedLine.toUpperCase();
            
            if (technicianMap.has(upperLine)) {
                currentTechnicianId = technicianMap.get(upperLine);
                positionCounter = 0;
                continue;
            }

            if (upperLine.includes('MANH√É')) { currentPeriod = "MANHA"; continue; }
            if (upperLine.includes('TARDE')) { currentPeriod = "TARDE"; continue; }
            
            if (/^\d/.test(trimmedLine)) {
                if (currentTechnicianId) {
                    const result = parseOsLine(trimmedLine);
                    if (result.success) {
                        const osData = { ...result.data, period: currentPeriod, technicianId: currentTechnicianId, position: positionCounter++ };
                        try {
                            const response = await fetch(`${API_URL}/service-orders`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(osData) });
                            if (response.ok) {
                                successCount++;
                            } else {
                                failedLines.push(trimmedLine);
                            }
                        } catch (err) {
                            failedLines.push(trimmedLine);
                        }
                    } else {
                        failedLines.push(`${trimmedLine} (Motivo: ${result.reason || 'Formato irreconhec√≠vel'})`);
                    }
                } else {
                    failedLines.push(`${trimmedLine} (Motivo: Nenhuma equipe de t√©cnico v√°lida definida acima)`);
                }
            } else {
                unfoundTechs.add(trimmedLine);
                currentTechnicianId = null; 
            }
        }
        
        let summary = `Importa√ß√£o finalizada!\n‚úîÔ∏è ${successCount} OS foram importadas com sucesso.`;
        if (unfoundTechs.size > 0) {
            summary += `\n\n‚ö†Ô∏è As seguintes linhas/nomes foram ignoradas (T√©cnicos n√£o cadastrados ou texto desconhecido):\n- ${[...unfoundTechs].join('\n- ')}`;
        }
        if (failedLines.length > 0) {
            summary += `\n\n‚ùå As seguintes linhas falharam no processamento:\n- ${failedLines.join('\n- ')}`;
        }
        alert(summary);

        loadAllOrders();
        importForm.reset();
    });

    // --- L√ìGICA DO MODAL DE EDI√á√ÉO ---
    async function openEditModal(orderId) {
        try {
            const response = await fetch(`${API_URL}/service-orders/${orderId}`);
            if (!response.ok) return alert('Erro ao buscar dados da OS.');
            const order = await response.json();
            
            document.getElementById('edit-os-id').value = order.id;
            document.getElementById('edit-clientId').value = order.clientId;
            document.getElementById('edit-clientName').value = order.clientName;
            document.getElementById('edit-address').value = order.address;
            document.getElementById('edit-problem').value = order.problemDescription;
            document.getElementById('edit-priority').value = order.priority;
            document.getElementById('edit-period').value = order.period;
            document.getElementById('edit-notes').value = order.notes || '';
            
            editModal.style.display = 'flex';
        } catch (error) {
            alert('Erro de conex√£o.');
        }
    }

    function closeEditModal() {
        editModal.style.display = 'none';
    }

    editForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const orderId = document.getElementById('edit-os-id').value;
        const updatedData = {
            clientId: document.getElementById('edit-clientId').value,
            clientName: document.getElementById('edit-clientName').value,
            address: document.getElementById('edit-address').value,
            problemDescription: document.getElementById('edit-problem').value,
            priority: document.getElementById('edit-priority').value,
            period: document.getElementById('edit-period').value,
            notes: document.getElementById('edit-notes').value
        };
        try {
            const response = await fetch(`${API_URL}/service-orders/${orderId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedData)
            });
            if (response.ok) {
                alert('OS atualizada com sucesso!');
                closeEditModal();
                loadAllOrders();
            } else {
                alert('Falha ao atualizar a OS.');
            }
        } catch (error) {
            alert('Erro de conex√£o ao salvar as altera√ß√µes.');
        }
    });
    
    window.onclick = (event) => {
        if (event.target == editModal) {
            closeEditModal();
        }
    }
    
    // --- NOVA L√ìGICA DE EXCLUS√ÉO EM MASSA (MAIS ROBUSTA) ---
    async function deleteAllOrders() {
        const confirmationText = "TEM CERTEZA?\n\nEsta a√ß√£o √© IRREVERS√çVEL e ir√° apagar TODAS as Ordens de Servi√ßo.\n\nDigite 'EXCLUIR' para confirmar.";
        const userInput = prompt(confirmationText);

        if (userInput !== 'EXCLUIR') {
            alert('A√ß√£o cancelada.');
            return;
        }

        document.body.style.cursor = 'wait';
        deleteAllBtn.disabled = true;
        deleteAllBtn.textContent = 'Excluindo...';

        try {
            // 1. Pega os IDs de todas as OS existentes
            const response = await fetch(`${API_URL}/service-orders`);
            const orders = await response.json();
            const orderIds = orders.map(o => o.id);

            if (orderIds.length === 0) {
                alert("Nenhuma Ordem de Servi√ßo para excluir.");
                return;
            }

            // 2. Deleta uma por uma em um loop
            let successCount = 0;
            for (const id of orderIds) {
                const deleteResponse = await fetch(`${API_URL}/service-orders/${id}`, { method: 'DELETE' });
                if (deleteResponse.ok) {
                    successCount++;
                }
            }

            alert(`${successCount} de ${orderIds.length} Ordens de Servi√ßo foram exclu√≠das com sucesso.`);
            loadAllOrders(); // Atualiza o painel

        } catch (error) {
            alert('Erro de conex√£o ao tentar excluir as OS.');
        } finally {
            document.body.style.cursor = 'default';
            deleteAllBtn.disabled = false;
            deleteAllBtn.textContent = 'Excluir Todas as OS';
        }
    }
</script>

</body>
</html>
